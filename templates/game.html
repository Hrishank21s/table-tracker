{% extends "base.html" %}

{% block title %}{{ game_type.title() }} - Table Tracker{% endblock %}

{% block styles %}
<style>
    .table-card {
        background: {% if game_type == 'pool' %}rgba(52, 152, 219, 0.1){% else %}rgba(46, 204, 113, 0.1){% endif %};
        border: 2px solid {% if game_type == 'pool' %}#3498db{% else %}#2ecc71{% endif %};
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        transition: all 0.3s ease;
    }
    .table-card.running { animation: pulse 2s infinite; }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 {% if game_type == 'pool' %}rgba(52, 152, 219, 0.7){% else %}rgba(46, 204, 113, 0.7){% endif %}; }
        70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
        100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
    }
    .sessions-container {
        max-height: 200px;
        overflow-y: auto;
        background: rgba(0,0,0,0.3);
        border-radius: 10px;
        padding: 10px;
        margin: 10px 0;
    }
    .session-item {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 10px;
        padding: 8px;
        margin: 5px 0;
        background: rgba(255,255,255,0.1);
        border-radius: 5px;
        font-size: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="navbar">
        <h1><i class="fas fa-{% if game_type == 'pool' %}circle{% else %}dot-circle{% endif %}"></i> {{ game_type.title() }} Tables</h1>
        <div>
            <a href="{{ url_for('home') }}" class="btn btn-primary">üè† Home</a>
            <a href="{{ url_for('mobile_page', game_type=game_type) }}" class="btn btn-success">üì± Mobile</a>
            <span>{{ current_user.username }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
        </div>
    </div>
    
    <div id="tablesContainer" class="grid grid-3">
        <div class="card">Loading tables...</div>
    </div>
</div>

<script>
let tables = {};
let updateInterval;

async function loadTables() {
    try {
        const response = await fetch(`/api/{{ game_type }}/tables`);
        const data = await response.json();
        
        if (data.success) {
            tables = data.tables;
            renderTables();
        }
    } catch (error) {
        console.error('Error loading tables:', error);
    }
}

function renderTables() {
    const container = document.getElementById('tablesContainer');
    container.innerHTML = Object.entries(tables).map(([id, table]) => `
        <div class="table-card ${table.status}">
            <h3>Table ${id}</h3>
            <div style="font-size: 24px; margin: 10px 0; color: ${table.status === 'running' ? '#2ecc71' : table.status === 'paused' ? '#f39c12' : '#95a5a6'};">
                ${table.time}
            </div>
            <div style="font-size: 18px; margin: 10px 0;">‚Çπ${table.amount.toFixed(2)}</div>
            <div style="margin: 10px 0;">
                Rate: ‚Çπ${table.rate}/min
                ${table.status === 'idle' ? `
                    <select onchange="updateRate('${id}', this.value)" style="margin-left: 10px; padding: 5px;">
                        ${[2.0, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6.0, 6.5].map(rate => 
                            `<option value="${rate}" ${rate === table.rate ? 'selected' : ''}>‚Çπ${rate}</option>`
                        ).join('')}
                    </select>
                ` : ''}
            </div>
            <div style="margin: 15px 0;">
                ${table.status === 'idle' ? `
                    <button onclick="tableAction('${id}', 'start')" class="btn btn-success">Start</button>
                ` : ''}
                ${table.status === 'running' ? `
                    <button onclick="tableAction('${id}', 'pause')" class="btn btn-warning">Pause</button>
                ` : ''}
                ${table.status === 'paused' ? `
                    <button onclick="tableAction('${id}', 'start')" class="btn btn-success">Resume</button>
                ` : ''}
                ${table.status !== 'idle' ? `
                    <button onclick="tableAction('${id}', 'end')" class="btn btn-danger">End</button>
                ` : ''}
            </div>
            ${table.sessions.length > 0 ? `
                <div>
                    <h4>Recent Sessions</h4>
                    <div class="sessions-container">
                        ${table.sessions.slice(-5).map(session => `
                            <div class="session-item">
                                <div>${session.start_time} - ${session.end_time}</div>
                                <div>${session.duration} min</div>
                                <div>‚Çπ${session.amount}</div>
                                <div>${session.date}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin: 10px 0;">
                        <input type="number" placeholder="Players" min="1" max="50" id="players-${id}" style="width: 80px; padding: 5px;">
                        <button onclick="splitBill('${id}')" class="btn btn-primary">Split Bill</button>
                        <button onclick="clearTable('${id}')" class="btn btn-danger">Clear</button>
                    </div>
                </div>
            ` : ''}
        </div>
    `).join('');
}

async function tableAction(tableId, action) {
    try {
        const response = await fetch(`/api/{{ game_type }}/table/${tableId}/action`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action })
        });
        
        const data = await response.json();
        if (data.success) {
            tables = data.tables;
            renderTables();
        }
    } catch (error) {
        console.error('Error with table action:', error);
    }
}

async function updateRate(tableId, rate) {
    try {
        const response = await fetch(`/api/{{ game_type }}/table/${tableId}/rate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rate: parseFloat(rate) })
        });
        
        const data = await response.json();
        if (data.success) {
            tables = data.tables;
            renderTables();
        }
    } catch (error) {
        console.error('Error updating rate:', error);
    }
}

async function splitBill(tableId) {
    const players = document.getElementById(`players-${tableId}`).value;
    if (!players || players < 1) {
        alert('Please enter valid number of players');
        return;
    }
    
    try {
        const response = await fetch(`/api/{{ game_type }}/table/${tableId}/split`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ players: parseInt(players) })
        });
        
        const data = await response.json();
        if (data.success) {
            alert(`Total: ‚Çπ${data.total_amount.toFixed(2)}\nPer Player: ‚Çπ${data.per_player.toFixed(2)}`);
        }
    } catch (error) {
        console.error('Error splitting bill:', error);
    }
}

async function clearTable(tableId) {
    if (!confirm('Clear all session data for this table?')) return;
    
    try {
        const response = await fetch(`/api/{{ game_type }}/table/${tableId}/clear`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        
        const data = await response.json();
        if (data.success) {
            tables = data.tables;
            renderTables();
        }
    } catch (error) {
        console.error('Error clearing table:', error);
    }
}

// Initialize
loadTables();
updateInterval = setInterval(loadTables, 1000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (updateInterval) clearInterval(updateInterval);
});
</script>
{% endblock %}
